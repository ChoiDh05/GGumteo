<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.ggumteo.mapper.admin.PayMapper">
    <!--작품 구매상품 조희-->
    <select id="selectWorkProducts" resultType="PayWorkDTO">
        SELECT
        p.id AS Id,
        p.post_type AS postType,
        p.post_title AS postTitle,
        mp.profile_name AS profileName,
        w.work_price AS workPrice,
        bw.created_date AS createdDate
        FROM
        tbl_buy_work bw
        INNER JOIN
        tbl_work w ON bw.work_id = w.id
        INNER JOIN
        tbl_post p ON w.id = p.id
        INNER JOIN
        tbl_member_profile mp ON bw.member_profile_id = mp.id
        WHERE
        p.post_type IN ('WORKVIDEO', 'WORKTEXT')

        <!-- 검색 조건 추가 -->
        <if test="search != null and search != ''">
            and (
            p.post_title like concat('%', #{search}, '%')
            or p.post_type like concat('%', #{search}, '%')
            or mp.profile_name like concat('%', #{search}, '%')
            )
        </if>
        <!-- 기본 정렬 설정 -->
        ORDER BY bw.created_date DESC
        <!-- 페이징 추가 -->
        limit #{pagination.startRow}, #{pagination.rowCount}
    </select>

    <!-- 작품 총 구매 목록 조회 -->
    <select id="workProductCounts" resultType="int">
        SELECT
        COUNT(*)
        FROM
        tbl_buy_work bw
        INNER JOIN
        tbl_work w ON bw.work_id = w.id
        INNER JOIN
        tbl_post p ON w.id = p.id
        INNER JOIN
        tbl_member_profile mp ON bw.member_profile_id = mp.id
        WHERE
        p.post_type IN ('WORKVIDEO', 'WORKTEXT')

        <!-- 검색 조건 추가 -->
        <if test="search != null and search != ''">
            and (
            p.post_title like concat('%', #{search}, '%')
            or p.post_type like concat('%', #{search}, '%')
            or mp.profile_name like concat('%', #{search}, '%')
            )
        </if>
    </select>
</mapper>