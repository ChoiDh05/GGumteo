<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.ggumteo.mapper.report.WorkReportMapper">
<!--관리자 영상 신고 조회-->
    <select id="selectVideoReports" resultType="WorkReportDTO">
        select
        p.id as postId,
        mp.profile_name as profileName,
        p.created_date as createdDate,
        w.genre_type as genreType,
        p.post_title as postTitle,
        w.read_count as readCount,
        w.star as star,
        w.work_price as workPrice,
        wr.report_status as reportStatus,

        -- 신고 내역 모달창에 필요한 내용
        rp.profile_name as reportProfileName,
        rp.profile_email as reportProfileEmail,
        wr.created_date as reportCreatedDate,
        wr.report_contents as reportContents
        from
        tbl_post p
        join tbl_member_profile mp on p.member_profile_id = mp.id
        join tbl_work w on p.id = w.id
        left join tbl_work_report wr on w.id = wr.work_id
        left join tbl_member_profile rp on wr.work_id = rp.member_id -- 신고자 정보

        where
        p.post_type = 'VIDEO'

        <!-- 신고 상태가 'REPORT'인 항목만 필터처리 -->
        <if test="reportStatus != null and reportStatus == 'REPORT'">
            and wr.report_status = #{reportStatus}
        </if>

        <!-- 검색 조건 -->
        <if test="search != null and search != ''">
            and (
            mp.profile_name like concat('%', #{search}, '%')
            or p.post_title like concat('%', #{search}, '%')
            or w.genre_type like concat('%', #{search}, '%')
            )
        </if>

        <!-- 정렬 조건 -->
        order by
        <choose>
            <when test="order == 'createdDate'">
                p.created_date desc
            </when>
            <when test="order == 'readCount'">
                w.read_count desc
            </when>
            <when test="order == 'star'">
                w.star desc
            </when>
            <otherwise>
                p.created_date desc
            </otherwise>
        </choose>

        limit #{pagination.startRow}, #{pagination.rowCount}
    </select>

    <!--관리자 전체 영상 신고글 조회-->
    <select id="countAllReports" resultType="int">
        select count(*)
        from tbl_post p
        join tbl_member_profile mp on p.member_profile_id = mp.id
        join tbl_work w on p.id = w.id
        left join tbl_work_report wr on w.id = wr.work_id
        left join tbl_member_profile rp on wr.work_id = rp.member_id -- 신고자 정보

        where
        p.post_type = 'VIDEO'  <!-- 'VIDEO' 타입만 조회 -->

        <!-- 신고 상태가 'REPORT'인 항목만 필터링 -->
        <if test="reportStatus != null and reportStatus == 'REPORT'">
            and wr.report_status = #{reportStatus}
        </if>

        <!-- 검색 조건 -->
        <if test="search != null and search != ''">
            and (
            mp.profile_name like concat('%', #{search}, '%')
            or p.post_title like concat('%', #{search}, '%')
            or w.genre_type like concat('%', #{search}, '%')
            )
        </if>
    </select>

    <!--관라자 신고 상태 변경-->
    <update id="updateReportStatus">
        update tbl_work_report
        set report_status = #{reportStatus}
        where id = #{reportId}
    </update>

</mapper>